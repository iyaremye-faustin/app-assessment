version: '3.8'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      # Host clients (your Spring Boot app) connect to localhost:9092
      # Container clients connect to kafka:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  crm-api:
    build:
      context: ./crm-api
    depends_on:
      - kafka
    environment:
      PORT: 8081
    ports:
      - "8081:8081"

  inventory:
    build:
      context: ./inventory
    depends_on:
      - kafka
    environment:
      PORT: 8082
    ports:
      - "8082:8082"

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data

  consumer-web:
    build:
      context: ./consumer-service
    command: python3 manage.py runserver 0.0.0.0:8000
    ports:
      - "8000:8000"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - kafka
      - redis

  consumer:
    build:
      context: ./consumer-service
    command: python3 manage.py consume_messages
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - kafka
      - redis

  k6-crm:
    image: grafana/k6:latest
    command: run /scripts/load-test.js
    volumes:
      - ./crm-api/load-test.js:/scripts/load-test.js:ro
    depends_on:
      - crm-api
    network_mode: host
    profiles:
      - testing

  k6-inventory:
    image: grafana/k6:latest
    command: run /scripts/load-test.js
    volumes:
      - ./inventory/load-test.js:/scripts/load-test.js:ro
    depends_on:
      - inventory
    network_mode: host
    profiles:
      - testing

volumes:
  redis-data: